(DEFINE-FILE-INFO PACKAGE "INTERLISP" READTABLE "INTERLISP" BASE 10)

(FILECREATED "29-Dec-2024 14:30:19" {DSK}<home>paolo>il>interpinkie>INTERPINKIE.;4 3498   

      :EDIT-BY "PA"

      :CHANGES-TO (VARS INTERPINKIECOMS)
                  (FNS END.FINGER.OUTPUT BEGIN.FINGER.OUTPUT CREATE.FINGER.STREAM)

      :PREVIOUS-DATE "28-Dec-2024 19:24:10" {DSK}<home>paolo>il>interpinkie>INTERPINKIE.;3)


(PRETTYCOMPRINT INTERPINKIECOMS)

(RPAQQ INTERPINKIECOMS ((* A finger client.)
                        (FNS BEGIN.FINGER.OUTPUT CREATE.FINGER.STREAM END.FINGER.OUTPUT 
                             PARSE.FINGER.QUERY QUERY.FINGER.SERVER)))



(* A finger client.)

(DEFINEQ

(BEGIN.FINGER.OUTPUT
  [LAMBDA (STREAM USER HOST)                                 (* ; "Edited 29-Dec-2024 14:27 by PA")

         (* Prepares STREAM for sending the output of a Finger query about USER at HOST.
         For example, if STREAM is associated with a window the function sets it to 
         read-write, clear it, and sets a title that reflects the queried user and host.)

    ])

(CREATE.FINGER.STREAM
  [LAMBDA (NEWINP)                                           (* ; "Edited 29-Dec-2024 14:23 by PA")

         (* Creates if necessary and returns a stream suitable for printing Finger output 
         to the primary output if NEWINP is NIL, to a new separate window otherwise.)

    (if NEWINP
        then (OUTPUT)
      else (OUTPUT])

(END.FINGER.OUTPUT
  [LAMBDA (STREAM)                                           (* ; "Edited 29-Dec-2024 14:29 by PA")

         (* Cleans up stream after printing the output of a Finger query.
         For example, if STREAM is associated with a window the function marks it as not 
         modified and sets it read-only.)

    ])

(PARSE.FINGER.QUERY
  [LAMBDA (QUERY)                                            (* ; "Edited 28-Dec-2024 19:00 by PA")

         (* Checks Finger QUERY and returns a cons
         (user . host) if valid, NIL otherwise. User is NIL if the username is missing 
         from QUERY. Assumes QUERY has no leading or trailing whitespace.)

    (LET ((@POS (STRPOS "@" QUERY)))                         (* QUERY must have a minimum length 
                                                             and not contain more than one @ 
                                                             character.)
         (if [AND (GEQ (NCHARS QUERY)
                       5)
                  (NULL (STRPOS "@" QUERY (ADD1 @POS]
             then (CONS (LET [(USER (SUBSTRING QUERY 1 (SUB1 @POS]
                             (if (GREATERP (NCHARS USER)
                                        0)
                                 then USER
                               else NIL))
                        (SUBSTRING QUERY (ADD1 @POS)))
           else NIL])

(QUERY.FINGER.SERVER
  [LAMBDA (USER HOST STREAM)                                 (* ; "Edited 28-Dec-2024 19:20 by PA")

         (* Queries Finger server HOST about USER and prints the response to STREAM which 
         defaults to the primary output if not supplied.
         If USER is NIL requests a list of users at HOST.)

    (ShellCommand (CONCAT "echo %"" (OR USER "")
                         "%"|nc -C -w 5 " HOST " 79|tr -d %"\r%"")
           (OR STREAM (OUTPUT])
)
(DECLARE%: DONTCOPY
  (FILEMAP (NIL (683 3475 (BEGIN.FINGER.OUTPUT 693 . 1110) (CREATE.FINGER.STREAM 1112 . 1502) (
END.FINGER.OUTPUT 1504 . 1861) (PARSE.FINGER.QUERY 1863 . 2970) (QUERY.FINGER.SERVER 2972 . 3473)))))
STOP
